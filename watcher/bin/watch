#!/usr/bin/env ruby
require 'artoo'
require 'net/http'

# Max time between clicks, we reset the count to 0 if exceeded
$timeout = 5

# The number of clicks needed to win
$winning_clicks = 10


$last_click_time = Time.now
$clicks = 0

connection :keyboard, adaptor: :keyboard
device :keyboard, driver: :keyboard, connection: :keyboard

work do
  puts "Start clicking"
  on keyboard, :key => :keypress
end

def keypress(sender, key)
  return unless key == 'space'
  click
end

def click
  if $last_click_time < (Time.now - $timeout)
    $clicks = 0
    puts "Starting, you must click at least once every #{$timeout} seconds"
  end
  $clicks += 1
  $last_click_time = Time.now
  puts $clicks
  win if $clicks == $winning_clicks
end

def win
  puts "you win!"
  do_derpler
end

def do_derpler
  uri = URI('http://ci.int.cozy.co/go/api/pipelines/velopsipede/schedule')
  http = Net::HTTP.new(uri.host, uri.port)
  request = Net::HTTP::Post.new(uri.request_uri)
  response = http.request(request)
end
