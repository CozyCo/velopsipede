#!/usr/bin/env ruby
require 'net/http'
require 'aws-sdk'

begin
  require 'piface'
  $pi == true
rescue
  $pi = false
end

# Max time between clicks, we reset the count to 0 if exceeded
$timeout = 5

# The number of clicks needed to win
$winning_clicks = 100


$last_click_time = Time.now
$clicks = 0
$last_button_state = 0


def click
  restart if $last_click_time < (Time.now - $timeout)
  $clicks += 1
  $last_click_time = Time.now
  puts $clicks
  win if $clicks == $winning_clicks
end

def restart
  $clicks = 0
  puts "Starting, you must click at least once every #{$timeout} seconds"
  led('green', 0)
end

def win
  puts "you win!"
  led('green', 1)
  do_derpler
  capture_portrait
end

def do_derpler
  uri = URI('http://ci.int.cozy.co/go/api/pipelines/velopsipede/schedule')
  http = Net::HTTP.new(uri.host, uri.port)
  request = Net::HTTP::Post.new(uri.request_uri)
  response = http.request(request)
end

def capture_portrait
  time = Time.now
  filename = "pederplerer-#{time}.jpg"
  `fswebcam -r 1280x720 --no-banner /home/pi/#{filename}`

  s3 = Aws::S3::Resource.new(region:'us-west-2')
  obj = s3.bucket('bikeface').object(filename)
  obj.upload_file("~/#{filename}", {:acl => 'public-read'})
end

def check_button
  state = Piface.read(0)
  if $last_button_state != state
    if state == 1
      click
      sleep 0.02
      if $clicks % 2 == 0
        led('yellow', 1)
      else
        led('yellow', 0)
      end
    end
  end
  $last_button_state = state
end

def led(color, value)
  if color == 'green'
    Piface.write(0, value)
  end
  if color == 'yellow'
    Piface.write(1, value)
  end
end

at_exit do
  led('green', 0)
  led('yellow', 0)
end

####
led('green', 0)
led('yellow', 0)

loop do
  check_button if $pi
  sleep 0.001
end
